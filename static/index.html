<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pipeman Schulb端cher</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <style>
        :root {
            --background-color: #2b2d30;
            --header-color: #335fb0;
            --text-color: #b0bac5;
            --header-background: #222225;
            --table-line: #b0bac5;
        }

        * {
            box-sizing: border-box;
            font-family: Arial, serif;
            font-size: 18px;
        }

        body {
            margin: 0;
            background: var(--background-color);
            background-image: url("https://pipeman.org/pipe.svg");
            background-size: 30px;
        }

        .top-nav {
            background-color: var(--header-background);
            overflow: hidden;
            width: min(95%, 400px);
            padding-left: 20px;
            padding-right: 20px;
            align-self: center;
        }

        .searchbar {
            vertical-align: center;
            height: 30px;
            width: min(100% - 10px, 400px);
            display: block;
            background: var(--background-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px;
            margin: 10px auto 1px;
        }

        .page-selector {
            height: 30px;
            width: 45px;
            border: none;
            background: var(--background-color);
            color: var(--text-color);
            border-radius: 6px;
        }

        .child {
            margin-top: 5px;
            margin-bottom: 5px;
            display: inline-block;
            vertical-align: middle;
        }

        button {
            background: #000000;
            font-size: 20px;
            border: none;
            background: var(--header-color);
            color: white;
            cursor: pointer;
            border-radius: 6px;
            padding-right: 10px;
            padding-left: 10px;
            transition-duration: 0.1s;
            height: 26px;
            margin-left: 3px;
            margin-right: 3px;
        }

        button:hover {
            background-image: linear-gradient(rgb(0 0 0/20%) 0 0);
        }

        button:active {
            scale: 0.9;
        }

        .suggestions {
            position: absolute;
            margin: auto;
            width: min(95%, 400px);
            background: var(--header-background);
            left: 50%;
            transform: translateX(-50%);
            z-index: 42;
            padding-top: 10px;
            padding-bottom: 10px;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .nav-bar-rounded-corners {
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .list-element {
            padding-top: 7px;
            padding-bottom: 7px;
        }

        .list-element:hover {
            background-image: linear-gradient(rgb(0 0 0/20%) 0 0);
        }

        .list-element-name {
            font-weight: bold;
            color: white;
            padding-left: 10px;
        }

        .list-element p {
            margin-top: 0;
            margin-bottom: 0;
        }

        .list-element-subject {
            color: var(--text-color);
            font-size: 16px;
            padding-left: 10px;
        }

        #book1 {
            border: none;
            transform-origin: 50% 0;
            box-sizing: border-box;
            height: fit-content;
        }

        .top-nav-wrapper {
            display: flex;
            width: 100%;
            flex-direction: column;
        }

        #max-page {
            color: var(--text-color);
        }

        #book-display {
            display: flex;
            height: calc(100vh - 90px);
            justify-content: center;
        }

        .highlight {
            background: rgba(255, 255, 0, 0.7);
        }

        #suggestions {
            list-style: none;
            padding-left: 0;
            margin: 5px 0 0;
        }

        .controls {
            text-align: center;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        .text-search:not([hidden]) {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 5px;
            gap: 5px;
            z-index: 13;
        }

        .text-search .searchbar {
            margin-top: 0;
        }

        .text-search h5, .text-search span {
            color: var(--text-color);
            font-weight: normal;
            font-size: 15px;
            white-space: nowrap;
            margin: 0;
        }

        .svg-button {
            padding: 1px;
            background: none;
        }

        .svg-button svg {
            color: var(--text-color);
        }
    </style>
</head>
<body>
<div class="top-nav-wrapper">
    <div class="top-nav nav-bar-rounded-corners" id="top-nav">
        <input class="searchbar" id="search" type="text" placeholder="Suche B端cher">

        <div class="controls" id="controls" hidden>
            <button onclick="changePage(-5)"><strong><<</strong></button>
            <button onclick="changePage(-1)"><strong><</strong></button>

            <input class="child page-selector" id="page-selector" type="text" placeholder="Seite">
            <a id="max-page" class="child">/ 42</a>

            <button onclick="changePage(1)"><strong>></strong></button>
            <button onclick="changePage(5)"><strong>>></strong></button>
            <button class="svg-button" style="width: 26px; height: 26px" onclick="toggleTextSearch()">
                <svg viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                    <ellipse style="stroke: currentColor; fill: none; stroke-linecap: round; stroke-width: 30px;"
                             cx="179.236" cy="178.236" rx="152.435" ry="152.435"/>
                    <path style="stroke: currentColor; fill: none; stroke-width: 20px; stroke-linecap: round;"
                          d="M 289.792 285.495 L 479.829 477.669"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<div class="suggestions" id="suggestions-div" hidden>
    <ul id="suggestions">

    </ul>
</div>
<div class="suggestions text-search" id="text-search-div" hidden="">
    <input placeholder="Im Buch suchen" class="searchbar" id="text-search-input" oninput="searchOnCurrentPage()">
    <h5><span id="result-count">0</span> Ergebnisse</h5>
    <button onclick="searchOnPreviousPage()"><strong><</strong></button>
    <button onclick="searchOnNextPage()"><strong>></strong></button>
</div>


<div id="book-display">
    <div id="book1" class="scaled-content">

    </div>
</div>
</body>
</html>
<script>
    let currentPage;
    let book = null;

    class Book {
        constructor(id, title, subject, pageCount) {
            this.pageCount = pageCount;
            this.subject = subject;
            this.title = title;
            this.id = id;
        }

        pageCount;
        subject;
        title;
        id;
    }

    document.getElementById("search").addEventListener("keyup", (event) => {
        if (event.code !== "Enter") return;
        event.preventDefault();
        const element = document.getElementById("suggestions").children.item(0);
        if (!element.classList.contains("no-enter-select")) element.click();
    });

    addEventListener("keydown", (event) => {
        if (book == null) return;

        switch (event.code) {
            case "ArrowRight": {
                changePage(1);
                break;
            }
            case "ArrowLeft": {
                changePage(-1);
                break;
            }
        }
    });

    function selectBook(newBook, page = 1) {
        book = newBook;
        currentPage = page;
        document.getElementById("controls").hidden = book == null;
        document.getElementById("max-page").innerHTML = "/ " + book.pageCount;
        setPage(page);
    }

    function changePage(lambda) {
        setPage(currentPage + lambda);
    }

    function setPage(page, updateInputField = true, after = null) {
        if (isNaN(page)) page = 1;
        currentPage = Math.max(1, Math.min(book.pageCount, page));
        if (updateInputField) document.getElementById("page-selector").value = currentPage;
        window.history.replaceState({}, null, "?book=" + book.id + "&page=" + currentPage);

        const promise = fetch(`/api/books/${book.id}/${currentPage}`).then(r => r.text().then(t => {
            const book = document.getElementById("book1");
            book.innerHTML = t
            resizeBook();
        }));

        if (after !== null) {
            promise.then(after);
        }
    }

    function doSearch() {
        let query = document.getElementById("search").value;
        fetch("/api/completions?query=" + query).then(r => r.json().then(resp => {
            const list = document.getElementById("suggestions");
            list.innerHTML = "";

            let hide = true;
            for (let i = 0; i < resp.length; i++) {
                const s = resp[i];
                addSearchResult(list, s["book"]["title"], s["book"]["subject"], s["page"], s["book"]["id"], false);
                hide = false;
            }

            if (resp.length === 0 && query.length > 0) {
                addSearchResult(list,
                    "Nicht gefunden?", "Dr端cke <span style='font-weight: bold'>hier</span>, um das neue Buch hinzuzuf端gen.",
                    0, 0, true
                );
                hide = false;
            }

            document.getElementById("suggestions-div").hidden = hide;
            if (hide) {
                hideSuggestions();
            } else {
                updateRoundedCorners();
            }
        }));
    }

    function addSearchResult(ul, title, subject, page, bookId, isUploadMessage) {
        const li = document.createElement("li");
        li.classList.add("list-element");
        li.appendChild(createThing("a", "list-element-name", title));
        if (!isUploadMessage) li.appendChild(createThing("a", "list-element-subject", " S. " + page));
        li.appendChild(createThing("p", "list-element-subject", subject));
        if (isUploadMessage) {
            li.addEventListener("click", () => {
                location.href = "/upload"
            });
        } else {
            li.addEventListener("click", () => {
                fetchBook(bookId).then(b => selectBook(b, page));
                hideSuggestions();
            });
        }
        if (isUploadMessage) li.classList.add("no-enter-select");

        ul.appendChild(li);
    }

    function createThing(obj, clazz, text) {
        const o = document.createElement(obj);
        o.classList.add(clazz);
        o.innerHTML = text;
        return o;
    }

    document.getElementById("page-selector").addEventListener("input", () => {
        setPage(parseInt(document.getElementById("page-selector").value), false);
    });

    function hideSuggestions() {
        document.getElementById("suggestions-div").hidden = true;
        updateRoundedCorners();
    }

    function updateRoundedCorners() {
        if (!document.getElementById("suggestions-div").hidden || !document.getElementById("text-search-div").hidden) {
            document.getElementById("top-nav").classList.remove("nav-bar-rounded-corners");
        } else {
            document.getElementById("top-nav").classList.add("nav-bar-rounded-corners");
        }
    }

    window.onclick = () => {
        hideSuggestions();
    };

    document.getElementById("search").addEventListener("input", () => {
        doSearch();
    });

    document.getElementById("search").addEventListener("focusin", () => {
        doSearch();
    });

    function fetchBook(id) {
        return fetch("/api/books/" + id).then(r => r.json().then(j => {
            return new Book(j["id"], j["title"], j["subject"], j["page-count"]);
        }));
    }

    const params = new URL(location.href).searchParams;
    if (params.has("book")) fetchBook(params.get("book")).then(b => selectBook(b, parseInt(params.get("page"))));

    addEventListener("resize", () => resizeBook());

    function applyScaling(scaledWrapper) {
        const scaledContent = scaledWrapper.getElementsByClassName('scaled-content')[0];
        scaledContent.style.transform = 'scale(1, 1)';

        const {width: cw, height: ch} = scaledContent.getBoundingClientRect();
        const {width: ww, height: wh} = scaledWrapper.getBoundingClientRect();

        const scaleAmount = Math.min(ww / cw, wh / ch);

        scaledContent.style.transform = `scale(${scaleAmount}, ${scaleAmount})`;
    }

    function resizeBook() {
        applyScaling(document.getElementById("book-display"));
    }

    function textSearch(url, changePage = false) {
        unhighlight();
        if (getQuery().length === 0) return;

        fetch(url).then(r => r.json().then(json => {
            const results = json["results"];
            if (changePage && results.length > 0) {
                setPage(results[0]["page"], true, () => {
                    highlightAll(results);
                    updateResultCount(json["total-results"]);
                });
            } else {
                highlightAll(results);
                updateResultCount(json["total-results"]);
            }
        }));
    }

    function updateResultCount(count) {
        document.getElementById("result-count").innerText = count;
    }

    function highlightAll(results) {
        for (let result of results) {
            let start = result["highlight"]["start"];
            highlight(start, start + result["highlight"]["length"]);
        }
    }

    function getQuery() {
        return document.getElementById("text-search-input").value;
    }

    function searchOnCurrentPage() {
        textSearch(`/api/text-search?query=${getQuery()}&book=${book.id}&page=${currentPage}`);
    }

    function searchOnNextPage() {
        textSearch(`/api/text-search?query=${getQuery()}&book=${book.id}&page=${currentPage}&location=after`, true);
    }

    function searchOnPreviousPage() {
        textSearch(`/api/text-search?query=${getQuery()}&book=${book.id}&page=${currentPage}&location=before`, true)
    }

    function highlight(start, end) {
        let curPos = 0;
        for (let element of document.getElementsByClassName("page")[0].children) {
            if (curPos <= end && curPos >= start) {
                highlightElement(element);
            }
            curPos += element.innerHTML.length + 1;
        }
    }

    function highlightElement(element) {
        const newNode = element.cloneNode(true);
        element.parentNode.append(newNode)
        newNode.classList.add("highlight");
    }

    function unhighlight() {
        const elements = document.getElementsByClassName("highlight");
        for (let i = elements.length - 1; i >= 0; i--) {
            elements[i].remove();
        }
    }

    function toggleTextSearch() {
        const element = document.getElementById("text-search-div");
        element.hidden = !element.hidden;
    }
</script>
